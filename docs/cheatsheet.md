# Шпаргалка по имитационному моделированию

> Все ключевые определения, формулы и справочные материалы курса **«Имитационное моделирование»** в одном месте.

---

## Краткое резюме по темам

### 1. Введение в ИМ
Имитационная модель --- это исполняемая модель системы, которая воспроизводит её поведение во времени. Три основных подхода --- системная динамика, агентное моделирование и дискретно-событийное моделирование --- покрывают задачи от стратегического до операционного уровня. ИМ применяется, когда аналитическое решение невозможно из-за сложности, нелинейности или стохастичности системы.

### 2. Системная динамика
Подход Форрестера: система описывается через накопители, потоки и петли обратной связи (усиливающие R и балансирующие B). Работает на макроуровне с агрегированными показателями и непрерывным временем. Классический пример --- модель диффузии Басса.

### 3. Агентное моделирование
Система описывается «снизу вверх»: множество автономных агентов с локальными правилами порождают сложное глобальное поведение (эмерджентность). Подходит для задач с неоднородностью участников --- эпидемиология, социальные системы, рынки. Охватывает диапазон от микро- до макроуровня.

### 4. Дискретно-событийное моделирование
Модельное время продвигается скачками от события к событию; состояние системы меняется только в эти дискретные моменты. Основные элементы --- сущности (заявки), ресурсы, очереди, процессы. Рабочая лошадка для логистики, производства и сервисных систем.

### 5. Основы теории массового обслуживания
СМО состоит из входящего потока заявок, каналов обслуживания и очереди (или отказа). Простейший (пуассоновский) поток обладает свойствами стационарности, ординарности и отсутствия последействия. Поведение СМО описывается марковскими процессами и уравнениями Колмогорова.

### 6. Теория очередей --- введение
Нотация Кендалла $A/S/m/B/K/SD$ систематизирует описание СМО. Закон Литтла $E[n] = \lambda \cdot E[r]$ связывает среднее число заявок в системе с интенсивностью потока и средним временем пребывания. Основные распределения: экспоненциальное (M), общее (G), детерминированное (D).

### 7. Анализ одиночной очереди
Модели M/M/1, M/M/m и M/M/m/B --- точные формулы для стационарных характеристик (загрузка, длина очереди, время ожидания, вероятность отказа). Формулы Эрланга B и C позволяют рассчитать системы с отказами и с ожиданием соответственно. Загрузка $\rho < 1$ --- необходимое условие устойчивости.

### 8. Сети массового обслуживания
Открытые сети (заявки приходят извне и уходят) и замкнутые сети (фиксированное число заявок циркулирует внутри). Теорема Джексона: в открытой сети с пуассоновскими потоками и экспоненциальным обслуживанием стационарное распределение имеет продуктовую форму. Каждый узел можно анализировать независимо.

### 9. SimPy --- основы
SimPy --- библиотека дискретно-событийного моделирования на Python, основанная на генераторах (yield). Основные абстракции: Environment, Process, Resource, Container, Store. Процессы взаимодействуют через события (timeout, request, put, get).

### 10. SimPy --- практика
Построение полных моделей: автомойка, кинотеатр, склад. Сбор статистики, визуализация результатов, анализ чувствительности. Практика использования Resource, Container и Store для реальных задач.

### 11. Моделирование и анализ
Методология симуляционного исследования по Law: формулировка задачи, сбор данных, построение модели, верификация, валидация, планирование экспериментов, анализ результатов. Важность многократных прогонов, доверительных интервалов и анализа переходного режима.

---

## Ключевые определения

**Имитационная модель**
:   Исполняемая (executable) модель системы --- набор правил, по которым из текущего состояния строится следующее. Запуск этих правил многократно порождает траекторию поведения системы во времени.

**Системная динамика**
:   Подход к моделированию на макроуровне через агрегированные **накопители** (stocks, интегралы), **потоки** (flows, производные) и **петли обратной связи** (усиливающие R --- «снежный ком», балансирующие B --- «термостат»).

**Агентное моделирование (ABM)**
:   Подход «снизу вверх»: **агент** --- автономная сущность с локальными правилами поведения; **среда** --- пространство, в котором агенты взаимодействуют; **эмерджентность** --- глобальное поведение, возникающее из локальных правил и не заложенное в них явно.

**Дискретно-событийное моделирование (DES)**
:   Подход, в котором **событие** --- мгновенное изменение состояния системы; **состояние системы** --- набор переменных, описывающих систему в данный момент; время продвигается скачками от события к событию.

**Система массового обслуживания (СМО)**
:   Система, состоящая из входящего потока заявок, **каналов** (серверов) обслуживания, **очереди** (буфера ожидания) и дисциплины обслуживания. **Заявка** --- единица работы, поступающая на обслуживание.

**Простейший (пуассоновский) поток**
:   Поток событий, обладающий тремя свойствами: *стационарность* (интенсивность $\lambda$ постоянна), *ординарность* (вероятность двух событий одновременно пренебрежимо мала), *отсутствие последействия* (будущие события не зависят от прошлых). Интервалы между событиями распределены экспоненциально.

**Марковский процесс**
:   Случайный процесс, в котором будущее состояние зависит только от текущего состояния и не зависит от предыстории (свойство отсутствия памяти). Для непрерывного времени описывается уравнениями Колмогорова.

**Нотация Кендалла $A/S/m/B/K/SD$**
:   Стандартная система обозначений для СМО: $A$ --- распределение интервалов прихода, $S$ --- распределение времени обслуживания, $m$ --- число каналов, $B$ --- ёмкость буфера, $K$ --- размер источника, $SD$ --- дисциплина очереди.

**Закон Литтла**
:   Фундаментальное соотношение теории очередей: среднее число заявок в системе равно произведению интенсивности входящего потока на среднее время пребывания: $E[n] = \lambda \cdot E[r]$. Справедлив для любой устойчивой системы.

**Продуктовая форма сети**
:   Свойство сети СМО (теорема Джексона), при котором совместное стационарное распределение числа заявок в узлах факторизуется в произведение маргинальных распределений отдельных узлов: $P(n_1, n_2, \ldots, n_K) = \prod_{i=1}^{K} p_i(n_i)$.

---

## Основные формулы

### Пуассоновский поток

Вероятность $m$ событий за время $\tau$:

$$P_m(\tau) = \frac{(\lambda\tau)^m}{m!}\,e^{-\lambda\tau}$$

Распределение интервалов между событиями (экспоненциальное):

$$F(t) = 1 - e^{-\lambda t}, \qquad E[T] = \frac{1}{\lambda}, \qquad D[T] = \frac{1}{\lambda^2}$$

---

### Закон Литтла

| Соотношение | Формула |
|---|---|
| Вся система | $E[n] = \lambda \cdot E[r]$ |
| Только очередь | $E[n_q] = \lambda \cdot E[w]$ |
| Связь времён | $E[r] = E[w] + E[s]$ |

где $E[n]$ --- среднее число заявок в системе, $E[n_q]$ --- в очереди, $E[r]$ --- среднее время пребывания, $E[w]$ --- среднее время ожидания, $E[s]$ --- среднее время обслуживания.

---

### Процессы гибели и размножения

Стационарное распределение:

$$p_k = \frac{\lambda_0 \lambda_1 \cdots \lambda_{k-1}}{\mu_1 \mu_2 \cdots \mu_k}\, p_0, \qquad k = 1, 2, \ldots$$

$$p_0 = \left(1 + \sum_{k=1}^{\infty}\frac{\lambda_0 \lambda_1 \cdots \lambda_{k-1}}{\mu_1 \mu_2 \cdots \mu_k}\right)^{-1}$$

---

### Уравнения Колмогорова (стационарные)

Для каждого состояния $k$ в стационарном режиме:

$$\sum_{\substack{j \neq k}} q_{jk}\, p_j = \left(\sum_{\substack{j \neq k}} q_{kj}\right) p_k$$

> Сумма потоков вероятности **в** состояние $k$ равна сумме потоков **из** состояния $k$.

---

### M/M/1

| Характеристика | Формула |
|---|---|
| Загрузка (условие устойчивости) | $\rho = \dfrac{\lambda}{\mu} < 1$ |
| Вероятность $n$ заявок в системе | $p_n = (1 - \rho)\,\rho^n$ |
| Среднее число заявок в системе | $E[n] = \dfrac{\rho}{1 - \rho}$ |
| Среднее число заявок в очереди | $E[n_q] = \dfrac{\rho^2}{1 - \rho}$ |
| Среднее время пребывания | $E[r] = \dfrac{1/\mu}{1 - \rho}$ |
| Среднее время ожидания | $E[w] = \dfrac{\rho / \mu}{1 - \rho}$ |
| Коэффициент использования канала | $U = \rho$ |

---

### M/M/m

| Характеристика | Формула |
|---|---|
| Загрузка на канал | $\rho = \dfrac{\lambda}{m\mu} < 1$ |
| Суммарная нагрузка | $a = \dfrac{\lambda}{\mu}$ |
| Вероятность пустой системы | $p_0 = \left[\sum_{k=0}^{m-1}\dfrac{a^k}{k!} + \dfrac{a^m}{m!}\cdot\dfrac{1}{1-\rho}\right]^{-1}$ |
| Формула Эрланга C (вероятность ожидания) | $C(m, a) = \dfrac{\dfrac{a^m}{m!}\cdot\dfrac{1}{1-\rho}}{\sum_{k=0}^{m-1}\dfrac{a^k}{k!} + \dfrac{a^m}{m!}\cdot\dfrac{1}{1-\rho}}$ |
| Среднее число в очереди | $E[n_q] = C(m,a)\cdot\dfrac{\rho}{1-\rho}$ |
| Среднее время ожидания | $E[w] = \dfrac{C(m,a)}{m\mu(1-\rho)}$ |

---

### Эрланг B --- СМО с отказами ($M/M/n/n$, $n$ каналов, без очереди)

| Характеристика | Формула |
|---|---|
| Нагрузка | $a = \dfrac{\lambda}{\mu}$ |
| Вероятность пустой системы | $p_0 = \left(\sum_{k=0}^{n}\dfrac{a^k}{k!}\right)^{-1}$ |
| Вероятность отказа (формула Эрланга B) | $P_{\text{отк}} = B(n, a) = \dfrac{\dfrac{a^n}{n!}}{\sum_{k=0}^{n}\dfrac{a^k}{k!}}$ |
| Относительная пропускная способность | $Q = 1 - P_{\text{отк}}$ |
| Абсолютная пропускная способность | $A = \lambda\, Q$ |
| Среднее число занятых каналов | $\bar{k} = a\,(1 - P_{\text{отк}})$ |

---

### СМО с ожиданием --- 1 канал, $m$ мест в очереди ($M/M/1/m{+}1$)

| Характеристика | Формула |
|---|---|
| Загрузка | $\rho = \dfrac{\lambda}{\mu}$ |
| Вероятность пустой системы ($\rho \neq 1$) | $p_0 = \dfrac{1 - \rho}{1 - \rho^{m+2}}$ |
| Вероятность $n$ заявок | $p_n = \rho^n\, p_0, \quad n = 0, 1, \ldots, m{+}1$ |
| Вероятность потери (буфер полон) | $P_{\text{отк}} = p_{m+1} = \rho^{m+1}\, p_0$ |
| Среднее число в системе | $E[n] = \dfrac{\rho}{1-\rho} - \dfrac{(m+2)\,\rho^{m+2}}{1 - \rho^{m+2}}$ |
| Среднее число в очереди | $E[n_q] = E[n] - (1 - p_0)$ |
| Среднее время пребывания | $E[r] = \dfrac{E[n]}{\lambda(1 - P_{\text{отк}})}$ |
| Среднее время ожидания | $E[w] = E[r] - \dfrac{1}{\mu}$ |

---

### Открытая сеть Джексона

Пусть сеть из $K$ узлов, каждый --- $M/M/m_i$. Эффективные интенсивности:

$$\Lambda_i = \gamma_i + \sum_{j=1}^{K} \Lambda_j\, r_{ji}, \quad i = 1, \ldots, K$$

где $\gamma_i$ --- внешний поток в узел $i$, $r_{ji}$ --- вероятность перехода из $j$ в $i$.

Продуктовая форма стационарного распределения:

$$P(n_1, n_2, \ldots, n_K) = \prod_{i=1}^{K} p_i(n_i)$$

где $p_i(n_i)$ --- стационарное распределение изолированного узла $i$ с интенсивностью $\Lambda_i$.

---

## SimPy --- краткий справочник

```python
import simpy

# === Создание среды ===
env = simpy.Environment()

# === Процесс (генератор) ===
def my_process(env):
    while True:
        print(f"Время: {env.now}")
        yield env.timeout(duration)        # ждать duration единиц времени

env.process(my_process(env))               # запустить процесс

# === Ресурс (Resource) --- каналы обслуживания ===
res = simpy.Resource(env, capacity=N)

def client(env, res):
    with res.request() as req:             # запрос ресурса
        yield req                          # ждать, пока ресурс освободится
        yield env.timeout(service_time)    # обслуживание

# === Ресурс с приоритетом ===
res = simpy.PriorityResource(env, capacity=N)
with res.request(priority=1) as req:       # меньшее число = выше приоритет
    yield req

# === Ресурс с вытеснением ===
res = simpy.PreemptiveResource(env, capacity=N)

# === Контейнер (Container) --- хранилище однородного ресурса ===
tank = simpy.Container(env, init=0, capacity=100)
yield tank.put(amount)                     # положить amount единиц
yield tank.get(amount)                     # забрать amount единиц
print(tank.level)                          # текущий уровень

# === Хранилище (Store) --- хранилище объектов ===
store = simpy.Store(env, capacity=10)
yield store.put(item)                      # положить объект
item = yield store.get()                   # забрать объект

# === FilterStore --- хранилище с фильтрацией ===
fstore = simpy.FilterStore(env, capacity=10)
item = yield fstore.get(lambda x: x.type == "A")

# === Запуск симуляции ===
env.run(until=T)                           # запустить до времени T
```

### Паттерн: генератор заявок + обслуживание

```python
import simpy
import random

def source(env, res, lambd):
    """Генератор заявок (пуассоновский поток)."""
    i = 0
    while True:
        yield env.timeout(random.expovariate(lambd))
        i += 1
        env.process(customer(env, res, f"Клиент-{i}"))

def customer(env, res, name):
    """Процесс обслуживания одной заявки."""
    arrival = env.now
    with res.request() as req:
        yield req
        wait = env.now - arrival
        yield env.timeout(random.expovariate(mu))
    # Заявка обслужена

env = simpy.Environment()
res = simpy.Resource(env, capacity=1)
env.process(source(env, res, lambd=1.0))
env.run(until=1000)
```

---

## Нотация Кендалла --- шпаргалка

Полная форма: **$A / S / m / B / K / SD$**

| Позиция | Обозначение | Смысл | Типичные значения |
|---|---|---|---|
| 1 | $A$ | Распределение интервалов прихода | **M** --- экспоненциальное (марковское), **D** --- детерминированное, **G** --- произвольное (general), **$E_k$** --- Эрланга порядка $k$ |
| 2 | $S$ | Распределение времени обслуживания | **M**, **D**, **G**, **$E_k$** --- аналогично |
| 3 | $m$ | Число каналов (серверов) | $1, 2, \ldots$ |
| 4 | $B$ | Ёмкость системы (каналы + очередь) | $m, m{+}1, \ldots, \infty$ (по умолчанию $\infty$) |
| 5 | $K$ | Размер источника (число потенциальных заявок) | $1, 2, \ldots, \infty$ (по умолчанию $\infty$) |
| 6 | $SD$ | Дисциплина очереди | **FIFO** (по умолчанию), **LIFO**, **SIRO** (случайный выбор), **PR** (приоритетная) |

!!! tip "Сокращённая запись"
    Если $B = \infty$, $K = \infty$ и $SD = \text{FIFO}$, их обычно опускают. Например, **M/M/1** означает $M/M/1/\infty/\infty/\text{FIFO}$.

### Примеры

| Обозначение | Описание |
|---|---|
| $M/M/1$ | 1 канал, пуассоновский поток, экспоненциальное обслуживание, бесконечная очередь |
| $M/M/m$ | $m$ каналов, бесконечная очередь |
| $M/M/m/m$ | $m$ каналов, **без очереди** (система с отказами, Эрланг B) |
| $M/M/1/K$ | 1 канал, буфер на $K$ мест (включая обслуживаемую заявку) |
| $M/G/1$ | 1 канал, произвольное обслуживание (формула Поллачека--Хинчина) |
| $M/D/1$ | 1 канал, детерминированное (фиксированное) время обслуживания |
| $G/G/m$ | Наиболее общий случай --- точных формул, как правило, нет |

---

## Краткая таблица обозначений

| Символ | Значение |
|---|---|
| $\lambda$ | Интенсивность входящего потока (заявок/ед. времени) |
| $\mu$ | Интенсивность обслуживания (заявок/ед. времени на 1 канал) |
| $\rho$ | Загрузка системы ($\lambda / \mu$ для 1 канала, $\lambda / (m\mu)$ для $m$ каналов) |
| $a = \lambda/\mu$ | Предложенная нагрузка (в Эрлангах) |
| $m$ | Число каналов обслуживания |
| $p_n$ | Вероятность $n$ заявок в системе в стационарном режиме |
| $E[n]$ | Среднее число заявок в системе |
| $E[n_q]$ | Среднее число заявок в очереди |
| $E[r]$ | Среднее время пребывания заявки в системе |
| $E[w]$ | Среднее время ожидания в очереди |
| $E[s] = 1/\mu$ | Среднее время обслуживания |
| $Q$ | Относительная пропускная способность |
| $A$ | Абсолютная пропускная способность |
| $P_{\text{отк}}$ | Вероятность отказа |

---

*Шпаргалка подготовлена на основе материалов курса «Имитационное моделирование» (ФКН ВШЭ).*
